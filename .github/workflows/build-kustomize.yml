name: Build Kustomize

on:
  pull_request:
    types:
      - opened
      - synchronize
    paths:
      - k8s/**/*.yaml

permissions: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
      - id: manifest-dirs
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const changedFiles = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner,
                repo,
                pull_number: number,
              },
              (response) => response.data.map((file) => file.filename),
            );

            const { existsSync } = require('fs');
            const { dirname, join } = require('path');

            const directories = [...new Set(
              changedFiles
                .map((file) => {
                  const directory = dirname(file);
                  if (existsSync(join(directory, 'kustomization.yaml'))) {
                    return directory;
                  }

                  return null;
                })
                .filter(Boolean)
            )];
            core.setOutput('directories', JSON.stringify(directories));
      - uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const { execSync } = require('child_process');

            const directories = ${{ steps.manifest-dirs.outputs.directories }};
            if (directories.length === 0) {
              core.info('No kustomization directories to build.');
              return;
            }

            const failedDirectories = [];
            for (const directory of directories) {
              core.startGroup(directory);
              try {
                execSync(`kustomize build --enable-helm "${directory}"`, {
                  stdio: 'pipe',
                  maxBuffer: 8 * 1024 * 1024, // 8 MB
                });
                core.info(`✅ Success: ${directory}`);
              } catch (error) {
                core.error(`❌ Failed: ${directory}`);
                core.error(error.stderr?.toString() || error.message);
                failedDirectories.push(directory);
              }
              core.endGroup();
            }

            if (failedDirectories.length > 0) {
              core.setFailed(`${failedDirectories.length} kustomization(s) failed to build: ${failedDirectories.join(', ')}`);
            }
