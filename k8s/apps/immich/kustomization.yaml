apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: immich

helmCharts:
  # Immich は 公式の Helm チャートが用意されているが、実装が不十分なので手書きする
  # https://immich.app/docs/install/kubernetes/
  - name: valkey
    releaseName: valkey
    version: 5.3.0
    repo: oci://registry-1.docker.io/bitnamicharts
    valuesInline:
      architecture: standalone
      auth:
        existingSecret: redis-secret
      global:
        imageRegistry: public.ecr.aws
        security:
          # imageRegistry を変更するために必要
          allowInsecureImages: true
      primary:
        extraEnvVars:
          - name: TZ
            value: Asia/Tokyo
        persistence:
          existingClaim: immich-redis-data
        resourcesPreset: nano
  - name: postgresql
    releaseName: postgresql
    version: 16.7.27
    repo: oci://registry-1.docker.io/bitnamicharts
    valuesInline:
      auth:
        database: immich
        existingSecret: postgresql-secret
        username: immich
      image:
        registry: ghcr.io
        repository: immich-app/postgres
        tag: 17-vectorchord0.4.3-pgvectors0.3.0
      global:
        security:
          # image を変更するために必要
          allowInsecureImages: true
      primary:
        extraEnvVars:
          - name: TZ
            value: Asia/Tokyo
        persistence:
          existingClaim: immich-postgresql-data
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
        initdb:
          args: --data-checksums
        containerSecurityContext:
          readOnlyRootFilesystem: false

resources:
  - ./resources/deployment.yaml
  - ./resources/service.yaml
  - ./resources/ingress.yaml
  - ./resources/secret.yaml
  - ./resources/volume-redis.yaml
  - ./resources/volume-postgresql.yaml

configMapGenerator:
  # https://immich.app/docs/install/environment-variables
  - name: app-config
    literals:
      - TZ=Asia/Tokyo
      - DB_HOSTNAME=postgresql
      - DB_USERNAME=immich
      - REDIS_HOSTNAME=valkey-primary
