apiVersion: batch/v1
kind: CronJob
metadata:
  name: cronjob

spec:
  schedule: "30 4 * * *"
  timeZone: Asia/Tokyo
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          containers:
            - name: app
              image: rclone/rclone:1.71.2@sha256:3103526c506266a9ecdf064efe99bf3677d92ef6407af124d8c56b4f49cbaa51
              command:
                - ash
                - -c
                - |
                  apk add zstd
                  tar -acpv -f /dest/volumes.zst --exclude='*.sock' /src || true
                  rclone copy --progress -v /dest Neotopia:Backup --config=/config/rclone/rclone.conf --onedrive-no-versions
                  rm -f /dest/volumes.zst
              volumeMounts:
                - name: src
                  mountPath: /src
                  readOnly: true
                - name: dest
                  mountPath: /dest
                - name: config
                  mountPath: /config/rclone
              securityContext:
                allowPrivilegeEscalation: false
          volumes:
            - name: src
              hostPath:
                path: /opt/k8s-volumes
                type: Directory
            - name: dest
              hostPath:
                path: /mnt/pool/backup
                type: DirectoryOrCreate
            - name: config
              hostPath:
                path: /opt/k8s-volumes/rclone-config
                type: Directory
          restartPolicy: Never
  concurrencyPolicy: Forbid
